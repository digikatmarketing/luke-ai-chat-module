{# =============================================================================
  Luke AI Chat Assistant — ElevenLabs Conversational AI Widget
  ─────────────────────────────────────────────────────────────────────────────
  HEADLESS MODULE — no floating button. Instead, any element on the page can
  trigger Luke's chat by adding:

    data-luke-trigger            opens voice + text chat (default)
    data-luke-trigger="text"     opens text-only chat

  Examples:
    <button data-luke-trigger>Talk to Luke</button>
    <a href="#" data-luke-trigger="text">Chat with Luke</a>
    <div class="hero-cta" data-luke-trigger>Ask Luke a question</div>

  The module itself renders as a hidden config container. It lazy-loads the
  ElevenLabs widget embed script only when a trigger is first clicked.

  Personalisation: HubSpot contact.firstname is injected into the greeting
  for identified visitors (those with a hutk cookie).

  Debug: add ?debugLuke=1 to the URL or enable in module settings.
============================================================================= #}

{% set pz_id = "luke-ai-cfg-" ~ name|replace(' ', '-')|replace('.', '-')|lower %}

{# === Personalisation: extract contact name if visitor is identified === #}
{% set visitor_name = contact.firstname|default("") %}
{% set visitor_email = contact.email|default("") %}

{# Build the greeting with name substitution #}
{% set greeting = module.greeting_text|default("Hey there, I'm Luke. I can answer any questions you have about Primal Zone and the services we offer, but cannot provide Medical advice. What brings you here today?") %}
{% if visitor_name %}
  {% set greeting = greeting|replace("{name}", visitor_name) %}
{% else %}
  {% set greeting = greeting|replace("{name}, ", "")|replace("{name} ", "")|replace("{name}", "") %}
  {% set greeting = greeting|replace("Hey , ", "Hey, ")|replace("Hey  ", "Hey ") %}
{% endif %}

{# Module-level image fallback: use uploaded image or theme default #}
{% set luke_image_src = module.avatar_image.src %}
{% if not luke_image_src %}
  {% set luke_image_src = get_asset_url("./images/luke-avatar.png") %}
{% endif %}

{# Settings (grouped fields) #}
{% set orb_color_1 = module.settings.orb_color_1.color|default("#4B6EFF") %}
{% set orb_color_2 = module.settings.orb_color_2.color|default("#8C68FF") %}
{% set enable_voice = module.settings.enable_voice|default(true) %}
{% set show_on_mobile = module.settings.show_on_mobile|default(true) %}
{% set widget_version = module.advanced.widget_version|default("0.3.0") %}
{% set debug_mode = module.advanced.debug_mode|default(false) %}

{# ========================= CSS ========================= #}
{% require_css %}
<style>
  {% scope_css %}

  /* Hidden config container — no visual output */
  .luke-ai-cfg {
    position: fixed;
    bottom: 0;
    right: 0;
    width: 0;
    height: 0;
    overflow: hidden;
    pointer-events: none;
    z-index: -1;
  }

  /* Debug panel */
  .luke-debug {
    display: none;
    position: fixed;
    left: 12px;
    bottom: 12px;
    max-width: 420px;
    width: calc(100% - 24px);
    padding: 10px;
    border-radius: 12px;
    border: 1px solid rgba(255, 255, 255, 0.14);
    background: rgba(0, 0, 0, 0.75);
    color: #fff;
    font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace;
    font-size: 11px;
    z-index: 10000;
    backdrop-filter: blur(8px);
    -webkit-backdrop-filter: blur(8px);
    max-height: 300px;
    overflow: auto;
    pointer-events: auto;
  }
  .luke-debug.is-on { display: block; }
  .luke-debug pre {
    margin: 0;
    white-space: pre-wrap;
    word-break: break-word;
    opacity: 0.95;
  }

  {% end_scope_css %}
</style>
{% end_require_css %}

{# ========================= HTML ========================= #}
{# Hidden config container — the widget gets appended to <body> by JS #}
<div id="{{ pz_id }}"
     class="luke-ai-cfg"
     data-agent-id="{{ module.agent_id }}"
     data-avatar-url="{{ luke_image_src }}"
     data-orb-color-1="{{ orb_color_1 }}"
     data-orb-color-2="{{ orb_color_2 }}"
     data-greeting="{{ greeting|e }}"
     data-enable-voice="{{ enable_voice|lower }}"
     data-widget-version="{{ widget_version }}"
     data-visitor-name="{{ visitor_name|e }}"
     data-visitor-email="{{ visitor_email|e }}"
     aria-hidden="true">
  <div class="luke-debug" data-debug>
    <strong>[LUKE-AI] Debug</strong>
    <pre data-debug-log>Waiting for trigger click…</pre>
  </div>
</div>

{# ========================= JS ========================= #}
{% require_js position="footer" %}
<script>
(function(){
  /* ── Root config element ───────────────────────────────── */
  var root = document.getElementById("{{ pz_id }}");
  if (!root) return;

  /* ── Config from data attributes ───────────────────────── */
  var CFG = {
    agentId:      root.getAttribute("data-agent-id") || "",
    avatarUrl:    root.getAttribute("data-avatar-url") || "",
    orbColor1:    root.getAttribute("data-orb-color-1") || "#4B6EFF",
    orbColor2:    root.getAttribute("data-orb-color-2") || "#8C68FF",
    greeting:     root.getAttribute("data-greeting") || "",
    enableVoice:  root.getAttribute("data-enable-voice") === "true",
    widgetVer:    root.getAttribute("data-widget-version") || "0.3.0",
    visitorName:  root.getAttribute("data-visitor-name") || "",
    visitorEmail: root.getAttribute("data-visitor-email") || ""
  };

  /* ── Debug ─────────────────────────────────────────────── */
  var qs = new URLSearchParams(window.location.search);
  var DEBUG = {{ debug_mode|lower }} || qs.has("debugLuke");

  var debugWrap = root.querySelector("[data-debug]");
  var debugPre  = root.querySelector("[data-debug-log]");

  if (DEBUG && debugWrap) debugWrap.classList.add("is-on");

  function log(msg, obj) {
    if (!DEBUG) return;
    var time = new Date().toISOString().slice(11, 19);
    var line = obj ? time + "  " + msg + "  " + JSON.stringify(obj) : time + "  " + msg;
    console.log("[LUKE-AI]", msg, obj || "");
    if (debugPre) {
      debugPre.textContent = (debugPre.textContent ? debugPre.textContent + "\n" : "") + line;
    }
  }

  /* ── Validate config ───────────────────────────────────── */
  if (!CFG.agentId) {
    log("ERROR: No agent ID configured. Luke AI will not function.");
    return;
  }

  /* ── State ─────────────────────────────────────────────── */
  var state = {
    scriptLoaded: false,
    widgetCreated: false,
    widgetEl: null
  };

  /* ── Find all trigger elements on the page ─────────────── */
  var triggers = document.querySelectorAll("[data-luke-trigger]");

  if (!triggers.length) {
    log("No [data-luke-trigger] elements found on page. Module is idle.");
    return;
  }

  log("Found " + triggers.length + " trigger(s)", {
    selectors: Array.prototype.map.call(triggers, function(t) {
      return t.tagName.toLowerCase() +
        (t.id ? "#" + t.id : "") +
        (t.className ? "." + t.className.split(" ")[0] : "");
    })
  });

  /* ── Lazy-load ElevenLabs widget embed script ──────────── */
  function ensureWidgetScript(callback) {
    if (state.scriptLoaded) {
      callback && callback();
      return;
    }

    /* Check if already loaded by another instance */
    if (window.customElements && window.customElements.get("elevenlabs-convai")) {
      log("Widget custom element already registered");
      state.scriptLoaded = true;
      callback && callback();
      return;
    }

    var src = "https://unpkg.com/@elevenlabs/convai-widget-embed@" + CFG.widgetVer;
    var s = document.createElement("script");
    s.src = src;
    s.async = true;

    s.onload = function() {
      log("Widget embed script loaded", { src: src });
      state.scriptLoaded = true;
      callback && callback();
    };

    s.onerror = function() {
      log("ERROR: Failed to load widget embed script", { src: src });
    };

    document.body.appendChild(s);
    log("Injecting widget embed script", { src: src });
  }

  /* ── Create the ElevenLabs widget element ──────────────── */
  function createWidget() {
    if (state.widgetCreated) return;

    var el = document.createElement("elevenlabs-convai");

    /* Core config */
    el.setAttribute("agent-id", CFG.agentId);

    /* Avatar customisation */
    if (CFG.avatarUrl) {
      el.setAttribute("avatar-image-url", CFG.avatarUrl);
    }
    el.setAttribute("avatar-orb-color-1", CFG.orbColor1);
    el.setAttribute("avatar-orb-color-2", CFG.orbColor2);

    /* Personalised first message */
    if (CFG.greeting) {
      el.setAttribute("override-first-message", CFG.greeting);
    }

    /* Dynamic variables for the agent's system prompt */
    var dynVars = {};
    if (CFG.visitorName) dynVars.user_name = CFG.visitorName;
    if (CFG.visitorEmail) dynVars.user_email = CFG.visitorEmail;
    if (Object.keys(dynVars).length > 0) {
      el.setAttribute("dynamic-variables", JSON.stringify(dynVars));
    }

    /* Listen for call events (client tool navigation) */
    el.addEventListener("elevenlabs-convai:call", function(evt) {
      log("elevenlabs-convai:call fired", evt.detail);

      if (evt.detail && evt.detail.tool_name) {
        var toolName = evt.detail.tool_name;
        if (toolName === "navigateToGetStarted") {
          window.location.href = "https://www.primalzone.com/get-started#signup-form";
        } else if (toolName === "navigateToBookCall") {
          window.location.href = "https://www.primalzone.com/#talk-to-us";
        } else if (toolName === "navigateToBloodTestMen") {
          window.location.href = "https://imedical.com.au/order/blood-tests/Primal-Zone-Panel-1&tracking=65ea48fc259cf";
        } else if (toolName === "navigateToBloodTestWomen") {
          window.location.href = "https://imedical.com.au/order/blood-tests/Primal-Zone-Female-Panel&tracking=65ea48fc259cf";
        }
      }
    });

    /* Listen for widget open/close — update trigger states */
    el.addEventListener("elevenlabs-convai:open", function() {
      log("Widget opened");
      triggers.forEach(function(t) { t.setAttribute("data-luke-active", "true"); });
    });

    el.addEventListener("elevenlabs-convai:close", function() {
      log("Widget closed");
      triggers.forEach(function(t) { t.removeAttribute("data-luke-active"); });
    });

    /* Append to body so it floats independently of page layout */
    document.body.appendChild(el);
    state.widgetCreated = true;
    state.widgetEl = el;
    log("Widget element created and appended to body", {
      agentId: CFG.agentId,
      hasName: !!CFG.visitorName,
      voiceEnabled: CFG.enableVoice
    });
  }

  /* ── Open Luke's chat ──────────────────────────────────── */
  function openLuke() {
    if (state.widgetCreated) {
      log("Widget already active");
      return;
    }

    ensureWidgetScript(function() {
      setTimeout(function() {
        createWidget();
      }, 150);
    });
  }

  /* ── Bind click handlers to all triggers ───────────────── */
  triggers.forEach(function(trigger) {
    trigger.addEventListener("click", function(e) {
      /* Prevent default if it's a link */
      if (trigger.tagName === "A") {
        e.preventDefault();
      }

      log("Trigger clicked", {
        tag: trigger.tagName,
        id: trigger.id || null,
        mode: trigger.getAttribute("data-luke-trigger") || "default"
      });

      openLuke();
    });
  });

  /* ── Also expose a global function for programmatic use ── */
  window.PrimalZone = window.PrimalZone || {};
  window.PrimalZone.openLukeAI = openLuke;

  /* ── Init ──────────────────────────────────────────────── */
  log("Luke AI module initialized (headless)", {
    agentId: CFG.agentId.slice(0, 12) + "…",
    hasVisitorName: !!CFG.visitorName,
    enableVoice: CFG.enableVoice,
    widgetVer: CFG.widgetVer,
    triggerCount: triggers.length
  });

})();
</script>
{% end_require_js %}
